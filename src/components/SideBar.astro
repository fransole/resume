---
import SideBarFooter from "./SideBarFooter.astro";
import { Image } from "astro:assets";
import SideBarMenu from "./SideBarMenu.astro";
import profileImg from "../images/john-dorion.png";
import darkProfileImg from "../images/dark-dorion.png";
import { getBaseUrl } from "../lib/getBaseUrl";
const base = getBaseUrl();
---

<div class="drawer-side z-40">
  <label for="my-drawer" class="drawer-overlay"></label>
  <aside class="px-2 pt-2 h-auto min-h-full w-[19rem] bg-base-200 text-base-content flex flex-col relative">
    <div id="logo-playground"></div>
    <div class="w-fit mx-auto mt-5 mb-6 relative z-10">
      <a href={base}>
        <div class="avatar transition ease-in-out hover:scale-[102%] block m-auto">
          <div class="w-[8.5rem]">
            <Image id="profile-img" class="mask mask-circle" format="webp" quality={80} loading="eager" width={300} height={300} src={profileImg} alt="John Dorion" data-default-src={profileImg.src} data-hover-src={darkProfileImg.src} />
          </div>
        </div>
      </a>
    </div>
    <div class="relative z-10">
      <SideBarMenu />
    </div>
    <div class="flex-grow"></div>
    <div class="relative z-10">
      <SideBarFooter />
    </div>
  </aside>
</div>

<style>
  #logo-playground {
    position: absolute;
    inset: 0;
    overflow: hidden;
    z-index: 0;
    pointer-events: auto;
  }

  #logo-playground :global(.logo-particle) {
    position: absolute;
    pointer-events: auto;
    will-change: transform, opacity, filter;
    cursor: default;
    transition: filter 0.3s ease, opacity 0.3s ease;
  }

  #logo-playground :global(.logo-particle:hover) {
    opacity: 0.9 !important;
    filter: drop-shadow(0 0 6px rgba(255, 220, 100, 0.9)) drop-shadow(0 0 14px rgba(255, 200, 50, 0.7));
  }

  #logo-playground :global(.logo-particle path) {
    fill: #C0A36E;
    fill-rule: evenodd;
    transition: fill 0.3s ease;
  }

  #logo-playground :global(.logo-particle:hover path) {
    fill: #D9C285;
  }
</style>

<script>
  import { setupAnimationEvents } from '../scripts/logoAnimation';
  setupAnimationEvents();

  // Profile image hover effect
  function initProfileImageHover() {
    const profileImg = document.getElementById('profile-img');
    if (!profileImg) return;

    const defaultSrc = profileImg.getAttribute('data-default-src');
    const hoverSrc = profileImg.getAttribute('data-hover-src');

    if (!defaultSrc || !hoverSrc) return;

    profileImg.addEventListener('mouseenter', () => {
      profileImg.setAttribute('src', hoverSrc);
    });

    profileImg.addEventListener('mouseleave', () => {
      profileImg.setAttribute('src', defaultSrc);
    });
  }

  // Initialize profile image hover
  initProfileImageHover();

  // Re-initialize on View Transitions navigation
  document.addEventListener('astro:page-load', initProfileImageHover);

  // Add swipe gesture to open/close sidebar on mobile
  function initSwipeGesture() {
    // Prevent duplicate listener registration
    if (window.__swipeListenerAttached) {
      return;
    }
    window.__swipeListenerAttached = true;

    let touchStartX = 0;
    let touchStartY = 0;
    let touchEndX = 0;
    let touchEndY = 0;

    const minSwipeDistance = 50; // Minimum distance for a swipe
    const maxVerticalDistance = 100; // Maximum vertical movement allowed
    const leftEdgeThreshold = 120; // Increased from 50px for easier access

    document.addEventListener('touchstart', (e) => {
      touchStartX = e.changedTouches[0].screenX;
      touchStartY = e.changedTouches[0].screenY;
    }, { passive: true });

    document.addEventListener('touchend', (e) => {
      touchEndX = e.changedTouches[0].screenX;
      touchEndY = e.changedTouches[0].screenY;
      handleSwipe();
    }, { passive: true });

    function handleSwipe() {
      const horizontalDistance = touchEndX - touchStartX;
      const verticalDistance = Math.abs(touchEndY - touchStartY);
      const drawer = document.getElementById('my-drawer') as HTMLInputElement;

      // Only trigger on mobile screens
      if (window.innerWidth >= 1024) return;
      if (!drawer) return;

      // Swipe right from left edge (open sidebar)
      if (
        touchStartX < leftEdgeThreshold && // Started near left edge
        horizontalDistance > minSwipeDistance && // Swiped right enough
        verticalDistance < maxVerticalDistance && // Mostly horizontal swipe
        !drawer.checked // Sidebar is closed
      ) {
        drawer.checked = true;
      }

      // Swipe left to close sidebar (from anywhere when sidebar is open)
      if (
        horizontalDistance < -minSwipeDistance && // Swiped left enough
        verticalDistance < maxVerticalDistance && // Mostly horizontal swipe
        drawer.checked // Sidebar is open
      ) {
        drawer.checked = false;
      }
    }
  }

  // Initialize on page load
  initSwipeGesture();

  // Re-initialize on View Transitions navigation
  document.addEventListener('astro:page-load', initSwipeGesture);
</script>
