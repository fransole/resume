---
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";
import { getBaseUrl } from "../lib/getBaseUrl";

export interface Props {
  title: string;
  img?: ImageMetadata | string;
  desc: string;
  url: string;
  badge?: string;
  tags?: string[];
  target?: "_blank" | "_self";
}

const base = getBaseUrl();

const { title, img, desc, url, badge, tags, target = "_blank" } = Astro.props;
const tagUrl = url.includes('/blog/')
  ? url.split("/").slice(0, -1).join("/") + "/tag"
  : `${base}blog/tag`;

// Validate and resolve image paths
const resolvedImg = (() => {
  if (typeof img !== 'string') return img;

  // Reject dangerous protocols
  const lowerImg = img.toLowerCase();
  if (lowerImg.startsWith('javascript:') || lowerImg.startsWith('data:') || lowerImg.startsWith('vbscript:')) {
    return undefined; // Reject dangerous URLs
  }

  // Prepend base URL for absolute paths
  if (img.startsWith('/')) {
    return base + img.slice(1);
  }

  return img;
})();
---

<div
  class="rounded-lg bg-base-100 hover:shadow-xl transition ease-in-out hover:scale-[102%]"
>
  <a href={url} target={target} rel={target === "_blank" ? "noopener noreferrer" : undefined}>
    <div class="hero-content flex-col md:flex-row">
      {
        resolvedImg && typeof resolvedImg === 'string' ? (
          <img
            src={resolvedImg}
            width={750}
            height={422}
            loading="lazy"
            alt={title}
            class="max-w-full md:max-w-[13rem] rounded-lg"
          />
        ) : resolvedImg && (
          <Image
            src={resolvedImg}
            width={750}
            height={422}
            format="webp"
            quality={80}
            loading="lazy"
            alt={title}
            class="max-w-full md:max-w-[13rem] rounded-lg"
          />
        )
      }
      <div class="grow w-full">
        <h1 class="text-xl font-bold">
          {title}
          {badge && <div class="badge badge-secondary mx-2">{badge}</div>}
        </h1>
        <p class="py-1 text-1xl">{desc}</p>
        <div class="card-actions justify-end">
          {
            tags &&
              tags.map((tag) => (
                <a href={`${tagUrl}/${tag}`} class="badge badge-outline">
                  {tag}
                </a>
              ))
          }
        </div>
      </div>
    </div>
  </a>
</div>
